{% extends "base.html" %}

{% block title %}Join Group - Telegram Bot Manager{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">
            <i class="fas fa-qrcode mr-3 text-telegram"></i>Join Our Telegram Group
        </h1>
        <p class="text-lg text-gray-600">Scan the QR code below with your Telegram app to join instantly</p>
    </div>

    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
        <div class="p-8">
            <div id="qr-container" class="text-center">
                <div id="loading" class="py-12">
                    <div class="inline-flex items-center px-4 py-2 font-semibold leading-6 text-sm shadow rounded-md text-telegram bg-white">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-telegram" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Generating QR Code...
                    </div>
                </div>
                
                <div id="qr-display" class="hidden">
                    <div class="bg-gray-50 rounded-lg p-8 mb-6 inline-block">
                        <img id="qr-image" src="" alt="QR Code" class="max-w-xs mx-auto">
                    </div>
                    <div class="space-y-4">
                        <p class="text-gray-600">
                            <i class="fas fa-mobile-alt mr-2 text-telegram"></i>
                            Open Telegram on your phone and scan this QR code
                        </p>
                        <div class="flex justify-center space-x-4">
                            <button onclick="generateNewQR()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg transition-colors disabled:opacity-50" id="refresh-btn">
                                <i class="fas fa-redo mr-2"></i>Generate New
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="success-message" class="hidden">
                    <div class="bg-green-50 border border-green-200 rounded-lg p-6">
                        <i class="fas fa-check-circle text-green-500 text-4xl mb-4"></i>
                        <h3 class="text-lg font-semibold text-green-800 mb-2">Successfully Connected!</h3>
                        <p class="text-green-700">Your Telegram session has been created successfully.</p>
                    </div>
                </div>
                
                <div id="duplicate-message" class="hidden">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                        <i class="fas fa-user-check text-blue-500 text-4xl mb-4"></i>
                        <h3 class="text-lg font-semibold text-blue-800 mb-2">Already Connected!</h3>
                        <p class="text-blue-700" id="duplicate-text">You have already scanned the QR code and created a valid session. Thank you for your support! ðŸŽ‰</p>
                        <div class="mt-4">
                            <button onclick="window.location.href='/'" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors">
                                <i class="fas fa-home mr-2"></i>Go to Dashboard
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="password-required" class="hidden">
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 mb-6">
                        <i class="fas fa-lock text-yellow-500 text-2xl mb-4"></i>
                        <h3 class="text-lg font-semibold text-yellow-800 mb-2">Two-Factor Authentication Required</h3>
                        <p class="text-yellow-700 mb-4">Please enter your 2FA password to complete the login.</p>
                        
                        <form id="password-form" class="space-y-4">
                            <input type="password" id="tfa-password" placeholder="Enter 2FA password" 
                                   class="w-full px-3 py-2 border border-yellow-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500">
                            <button type="submit" class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors">
                                <i class="fas fa-unlock mr-2"></i>Verify
                            </button>
                        </form>
                    </div>
                </div>
                
                <div id="expired-message" class="hidden">
                    <div class="bg-red-50 border border-red-200 rounded-lg p-6">
                        <i class="fas fa-clock text-red-500 text-2xl mb-4"></i>
                        <h3 class="text-lg font-semibold text-red-800 mb-2">QR Code Expired</h3>
                        <p class="text-red-700 mb-4">The QR code has expired. Please generate a new one.</p>
                        <button onclick="generateNewQR()" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors">
                            <i class="fas fa-redo mr-2"></i>Generate New QR
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentSession = null;
let statusInterval = null;
let isGenerating = false;

async function generateNewQR() {
    if (isGenerating) return; // Prevent concurrent requests
    isGenerating = true;
    
    showElement('loading');
    hideElements(['qr-display', 'success-message', 'password-required', 'expired-message', 'duplicate-message']);
    stopStatusCheck();
    
    try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000); // 10s timeout
        
        const response = await fetch('/api/sessions/qr', { 
            method: 'POST',
            signal: controller.signal,
            headers: {
                'Cache-Control': 'no-cache',
                'Pragma': 'no-cache'
            }
        });
        
        clearTimeout(timeoutId);
        const data = await response.json();
        
        if (data.success && data.data.qr_image) {
            currentSession = data.data.session_name;
            document.getElementById('qr-image').src = data.data.qr_image;
            showElement('qr-display');
            hideElement('loading');
            startStatusCheck();
        } else {
            throw new Error(data.error || 'Failed to generate QR code');
        }
    } catch (error) {
        if (error.name === 'AbortError') {
            showToast('Request timeout - please try again', 'error');
        } else {
            showToast(error.message || 'Network error occurred', 'error');
        }
        hideElement('loading');
    } finally {
        isGenerating = false;
    }
}

async function checkStatus() {
    if (!currentSession) return;
    
    try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);
        
        const response = await fetch(`/api/sessions/${currentSession}/qr-status`, {
            signal: controller.signal,
            headers: { 'Cache-Control': 'no-cache' }
        });
        
        clearTimeout(timeoutId);
        const data = await response.json();
        
        if (data.success) {
            const status = data.data.status;
            
            switch (status) {
                case 'success':
                    stopStatusCheck();
                    hideElements(['qr-display', 'loading']);
                    showElement('success-message');
                    setTimeout(() => window.location.href = '/', 2000);
                    break;
                case 'duplicate':
                    stopStatusCheck();
                    hideElements(['qr-display', 'loading']);
                    if (data.data.message) {
                        document.getElementById('duplicate-text').textContent = data.data.message;
                    }
                    showElement('duplicate-message');
                    break;
                case 'password_required':
                    stopStatusCheck();
                    hideElements(['qr-display', 'loading']);
                    showElement('password-required');
                    break;
                case 'expired':
                    stopStatusCheck();
                    hideElements(['qr-display', 'loading']);
                    showElement('expired-message');
                    break;
            }
        }
    } catch (error) {
        if (error.name !== 'AbortError') {
            console.error('Status check failed:', error);
        }
    }
}

function startStatusCheck() {
    statusInterval = setInterval(checkStatus, 1500); // Faster polling
}

function stopStatusCheck() {
    if (statusInterval) {
        clearInterval(statusInterval);
        statusInterval = null;
    }
}

function showElement(id) {
    document.getElementById(id).classList.remove('hidden');
}

function hideElement(id) {
    document.getElementById(id).classList.add('hidden');
}

function hideElements(ids) {
    ids.forEach(id => hideElement(id));
}

// 2FA form handler
document.getElementById('password-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const password = document.getElementById('tfa-password').value;
    
    try {
        const formData = new FormData();
        formData.append('password', password);
        
        const response = await fetch(`/api/sessions/${currentSession}/verify-2fa`, {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            if (data.data.status === 'success') {
                hideElement('password-required');
                showElement('success-message');
                showToast('2FA verification successful!', 'success');
                setTimeout(() => window.location.href = '/', 2000);
            } else {
                showToast('Invalid password. Please try again.', 'error');
            }
        } else {
            showToast('Verification failed', 'error');
        }
    } catch (error) {
        showToast('Verification failed', 'error');
    }
});

// Start QR generation on page load with slight delay for better UX
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(generateNewQR, 100);
});

// Add retry mechanism for failed requests
let retryCount = 0;
const maxRetries = 3;

function retryGeneration() {
    if (retryCount < maxRetries) {
        retryCount++;
        setTimeout(generateNewQR, 1000 * retryCount);
    }
}

// Performance optimization: preload next QR if needed
function preloadNextQR() {
    if (!isGenerating && currentSession) {
        // Could implement QR preloading logic here if needed
    }
}

// Cleanup on page unload
window.addEventListener('beforeunload', stopStatusCheck);
</script>
{% endblock %}